# âš¡ MetaNode Stake - Web3 å…¨æ ˆæµåŠ¨æ€§è´¨æŠ¼ DApp

MetaNode Stake æ˜¯ä¸€ä¸ªå®Œæ•´çš„ Web3 å…¨æ ˆå»ä¸­å¿ƒåŒ–åº”ç”¨ï¼ˆDAppï¼‰ã€‚æœ¬é¡¹ç›®å®ç°äº†ä¸€ä¸ªæ”¯æŒåŸç”Ÿä»£å¸ï¼ˆETHï¼‰ä¸ ERC20 ä»£å¸çš„æµåŠ¨æ€§è´¨æŠ¼æ± ï¼Œå¹¶é€šè¿‡ UUPS ä»£ç†æ¨¡å¼å®ç°äº†æ™ºèƒ½åˆçº¦çš„å¯å‡çº§æ¶æ„ã€‚å‰ç«¯é‡‡ç”¨ Next.js + Wagmi + Viem æ„å»ºï¼Œä¸æœ¬åœ° Hardhat èŠ‚ç‚¹å®ç°äº†å®Œç¾çš„å®æ—¶äº¤äº’ã€‚

---

## ğŸ§  æ ¸å¿ƒä¸šåŠ¡é€»è¾‘è¯´æ˜

æœ¬é¡¹ç›®çš„æ™ºèƒ½åˆçº¦è®¾è®¡äº†æå…¶ä¸¥è°¨çš„**â€œè´¨æŠ¼ -> ç”Ÿæ¯ -> è§£ç»‘ -> æç°â€**å…¨ç”Ÿå‘½å‘¨æœŸé—­ç¯ï¼Œæœ‰æ•ˆé˜²èŒƒäº†èµ„é‡‘çš„å¿«è¿›å¿«å‡ºï¼Œå¹¶ä¼˜åŒ–äº† Gas æ¶ˆè€—ã€‚

### 1. è´¨æŠ¼ (Stake / Deposit)
* **æ”¯æŒå¤šèµ„äº§ï¼š** ç”¨æˆ·å¯ä»¥å°†åŸç”Ÿ ETHï¼ˆæ”¾å…¥ PID=0 çš„æ± å­ï¼Œè°ƒç”¨ `depositETH`ï¼‰æˆ–æŒ‡å®šçš„ ERC20 ä»£å¸ï¼ˆè°ƒç”¨ `deposit`ï¼‰å­˜å…¥æ™ºèƒ½åˆçº¦ã€‚
* **æ”¶ç›Šå¿«ç…§ï¼š** æ¯æ¬¡ç”¨æˆ·è¿½åŠ è´¨æŠ¼æ—¶ï¼Œåˆçº¦ä¼šè‡ªåŠ¨è§¦å‘ `_deposit` å†…éƒ¨é€»è¾‘ï¼Œè®¡ç®—å¹¶ç»“ç®—ç”¨æˆ·ä¹‹å‰çš„å†å²æ”¶ç›Šï¼Œå°†å…¶å®‰å…¨æš‚å­˜åˆ° `pendingMetaNode` å˜é‡ä¸­ï¼Œç¡®ä¿æœ¬é‡‘å˜åŠ¨ä¸ä¼šå¯¼è‡´å†å²æ”¶ç›Šè®¡ç®—é”™ä¹±ã€‚

### 2. æ”¶ç›Šè®¡ç®— (Yield Farming)
* **åŒºå—é©±åŠ¨ï¼š** æ”¶ç›Šçš„äº§å‡ºä»¥â€œåŒºå—é«˜åº¦â€ä¸ºæ—¶é—´è½´ã€‚æœ¬åœ° Hardhat èŠ‚ç‚¹å·²åœ¨ `hardhat.config.js` ä¸­é…ç½®ä¸º**æ¯ 3 ç§’è‡ªåŠ¨äº§å‡ºä¸€ä¸ªæ–°åŒºå—**ã€‚
* **æƒé‡åˆ†é…ï¼š** æ”¶ç›Šæ± æ”¯æŒå¤šæ± æƒé‡åˆ†é…ï¼ˆ`poolWeight`ï¼‰ï¼Œç³»ç»Ÿä¼šæ ¹æ®å½“å‰æ± å­çš„æƒé‡å æ¯”ï¼Œå°†æ¯ä¸ªåŒºå—äº§å‡ºçš„æ€» MetaNode å¥–åŠ±åˆ†é…ç»™å½“å‰æ± å­çš„è´¨æŠ¼è€…ã€‚
* **æ—  Gas å®æ—¶æ¨å¯¼ï¼š** å‰ç«¯æ— éœ€å‘é€äº¤æ˜“ï¼Œç›´æ¥é€šè¿‡å®šæ—¶ï¼ˆå¦‚æ¯ 5 ç§’ï¼‰è°ƒç”¨åˆçº¦çš„åªè¯»è§†å›¾å‡½æ•° `pendingMetaNode`ï¼Œå³å¯åŸºäºå½“å‰æœ€æ–°åŒºå—é«˜åº¦åŠ¨æ€æ¨å¯¼å‡ºç”¨æˆ·çš„å®æ—¶æ”¶ç›Šï¼Œå®ç°å‰ç«¯é¡µé¢æ”¶ç›Šæ•°å€¼çš„â€œå…¨è‡ªåŠ¨è¯»ç§’å¢é•¿â€ã€‚

### 3. æå–æ”¶ç›Š (Claim)
* **éšæ—¶æå–ï¼š** ç”¨æˆ·å¯ä»¥éšæ—¶åœ¨å‰ç«¯ç‚¹å‡» Claimï¼Œè°ƒç”¨åˆçº¦çš„ `claim` æ–¹æ³•ã€‚
* **æœ¬æ¯åˆ†ç¦»ï¼š** æå–æ”¶ç›Šçš„æ“ä½œåªä¼šå°†æš‚å­˜åŒºå’Œæœ€æ–°äº§ç”Ÿçš„ MetaNode ä»£å¸è½¬å…¥ç”¨æˆ·é’±åŒ…ï¼Œ**å®Œå…¨ä¸ä¼šå½±å“ç”¨æˆ·æ­£åœ¨è´¨æŠ¼çš„æœ¬é‡‘**ã€‚

### 4. è§£è´¨æŠ¼ (Unstake / Request Withdraw)
* **é”å®šæœŸæœºåˆ¶ï¼š** å½“ç”¨æˆ·å†³å®šé€€å‡ºè´¨æŠ¼æ—¶ï¼Œè°ƒç”¨ `unstake` æ–¹æ³•ã€‚æ­¤æ—¶èµ„é‡‘**ä¸ä¼šç«‹åˆ»é€€å›é’±åŒ…**ã€‚
* **è¿›å…¥é˜Ÿåˆ—ï¼š** åˆçº¦ä¼šæ‰£é™¤ç”¨æˆ·çš„æœ‰æ•ˆç”Ÿæ¯æœ¬é‡‘ï¼Œå¹¶å°†è¿™ç¬”é€€æ¬¾è¯·æ±‚å‹å…¥ä¸€ä¸ª**è§£ç»‘é˜Ÿåˆ—ï¼ˆUnstake Requestsï¼‰**ä¸­ï¼ŒåŒæ—¶è®°å½•è¯¥ç¬”èµ„é‡‘çš„è§£é”åŒºå—é«˜åº¦ï¼ˆå½“å‰åŒºå—é«˜åº¦ + `unstakeLockedBlocks` é”å®šæœŸï¼‰ã€‚

### 5. æç°æœ¬é‡‘ (Withdraw)
* **åˆ°æœŸæç°ï¼š** åªæœ‰å½“ç½‘ç»œå½“å‰çš„åŒºå—é«˜åº¦è¶…è¶Šäº†é˜Ÿåˆ—ä¸­è®°å½•çš„è§£é”åŒºå—é«˜åº¦åï¼Œç”¨æˆ·æ‰èƒ½æç°ã€‚
* **æ‰¹é‡é‡Šæ”¾ï¼š** ç”¨æˆ·è°ƒç”¨ `withdraw` æ–¹æ³•ï¼Œæ™ºèƒ½åˆçº¦ä¼šéå†è§£ç»‘é˜Ÿåˆ—ï¼Œè‡ªåŠ¨æŒ‘å‡ºæ‰€æœ‰å·²è¿‡é”å®šæœŸçš„èµ„é‡‘è¿›è¡Œç´¯åŠ ï¼Œå°†å®ƒä»¬ä¸€æ¬¡æ€§å®‰å…¨é€€å›ç”¨æˆ·çš„é’±åŒ…ï¼Œå¹¶æ¸…ç†é‡Šæ”¾é˜Ÿåˆ—çš„å­˜å‚¨ç©ºé—´ï¼ˆé€€è¿˜éƒ¨åˆ† Gasï¼‰ã€‚

---

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

* **æ™ºèƒ½åˆçº¦ (Backend):** Solidity (0.8.20), Hardhat, OpenZeppelin (UUPS Upgradeable, Pausable, AccessControl)
* **å‰ç«¯ (Frontend):** Next.js (React), TypeScript, TailwindCSS
* **Web3 äº¤äº’ (SDK):** Wagmi, Viem, RainbowKit

---

## ğŸš€ å¿«é€Ÿå¯åŠ¨ä¸è”è°ƒæŒ‡å—

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹é¡ºåºå¯åŠ¨é¡¹ç›®ï¼Œç¡®ä¿å‰åç«¯ä¸æœ¬åœ°åŒºå—é“¾ç¯å¢ƒå®Œç¾åŒæ­¥ã€‚

### ç¬¬ä¸€æ­¥ï¼šç¯å¢ƒå‡†å¤‡ä¸ä¾èµ–å®‰è£…
åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹ï¼Œåˆ†åˆ«å®‰è£…åˆçº¦ç«¯å’Œå‰ç«¯çš„ä¾èµ–åŒ…ï¼š
```bash
# 1. å®‰è£…æ™ºèƒ½åˆçº¦ä¾èµ–
npm install 

# 2. è¿›å…¥å‰ç«¯ç›®å½•ï¼Œå®‰è£…å‰ç«¯ä¾èµ–
cd stake-fe
npm install #
```

### ç¬¬äºŒæ­¥ï¼šå¯åŠ¨æœ¬åœ° Hardhat èŠ‚ç‚¹
æ‰“å¼€ç¬¬ä¸€ä¸ªç»ˆç«¯ï¼ˆTerminal 1ï¼‰ï¼Œåœ¨é¡¹ç›®æ ¹ç›®å½•å¯åŠ¨æœ¬åœ°æµ‹è¯•é“¾ï¼š

```Bash
npx hardhat node
```
ğŸ’¡æ³¨ï¼šå¯åŠ¨åï¼Œç”±äºé…ç½®äº†è‡ªåŠ¨æŒ–çŸ¿ï¼Œç»ˆç«¯ä¼šæ¯éš” 3 ç§’è‡ªåŠ¨æ‰“å° Block #x minedã€‚è¯·ä¿æŒæ­¤ç»ˆç«¯å¼€å¯ã€‚

### ç¬¬ä¸‰æ­¥ï¼šç¼–è¯‘å¹¶éƒ¨ç½²æ™ºèƒ½åˆçº¦
æ‰“å¼€ç¬¬äºŒä¸ªç»ˆç«¯ï¼ˆTerminal 2ï¼‰ï¼Œåœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œéƒ¨ç½²å‘½ä»¤ï¼š

```Bash
# 1. å¼ºåˆ¶æ¸…ç†æ—§ç¼“å­˜å¹¶é‡æ–°ç¼–è¯‘æœ€æ–°åˆçº¦
npx hardhat clean
npx hardhat compile

# 2. å°†åˆçº¦éƒ¨ç½²åˆ°å¸¸é©»çš„ localhost èŠ‚ç‚¹
npx hardhat run scripts/deploy.js --network localhost
```
âš ï¸ å…³é”®ï¼š éƒ¨ç½²å®Œæˆåï¼Œæ§åˆ¶å°æœ€åä¼šæ‰“å°å‡º MetaNodeStake éƒ¨ç½²åœ°å€: 0x...ã€‚è¯·åŠ¡å¿…å¤åˆ¶è¿™ä¸ªåœ°å€ï¼

### ç¬¬å››æ­¥ï¼šé…ç½®å‰ç«¯ç¯å¢ƒå˜é‡
è¿›å…¥å‰ç«¯ç›®å½• stake-feï¼Œæ‰¾åˆ°æˆ–æ–°å»ºç¯å¢ƒé…ç½®æ–‡ä»¶ .envï¼ˆæˆ–ä¿®æ”¹ src/utils/env.tsï¼‰ï¼š
```ä»£ç æ®µ
NEXT_PUBLIC_STAKE_ADDRESS=0xä½ åˆšåˆšå¤åˆ¶çš„MetaNodeStakeéƒ¨ç½²åœ°å€
```

### ç¬¬äº”æ­¥ï¼šå¯åŠ¨å‰ç«¯é¡¹ç›®
åœ¨**ç¬¬ä¸‰ä¸ªç»ˆç«¯ï¼ˆTerminal 3ï¼‰**ä¸­ï¼Œè¿›å…¥ stake-fe ç›®å½•å¹¶å¯åŠ¨å‰ç«¯æœåŠ¡ï¼š

```Bash
cd stake-fe
npm run dev
```
æ‰“å¼€æµè§ˆå™¨è®¿é—® http://localhost:3000ã€‚è¿æ¥ä½ çš„ MetaMask é’±åŒ…ï¼ˆç¡®ä¿ç½‘ç»œé€‰å®šä¸º Hardhat Localhost 8545ï¼Œä¸”æ‹¥æœ‰æµ‹è¯• ETHï¼‰ï¼Œå³å¯å¼€å§‹å…¨æ ˆ DApp çš„é¡ºç•…ä½“éªŒï¼

## ğŸš‘ å¸¸è§ Web3 æœ¬åœ°è”è°ƒè¸©å‘æŒ‡å— (Troubleshooting)
åœ¨æœ¬åœ°é‡å¯èŠ‚ç‚¹æˆ–é‡æ–°éƒ¨ç½²åï¼Œææ˜“å‡ºç°ä»¥ä¸‹ç¼“å­˜å¯¼è‡´çš„ç„å­¦æŠ¥é”™ã€‚åªéœ€å¯¹ç—‡ä¸‹è¯å³å¯ç§’æ€ï¼š

#### 1.æŠ¥é”™ï¼šReplacement transaction underpriced æˆ– Nonce é”™ä¹±
ç—…å› ï¼š èŠ‚ç‚¹é‡å¯å¯¼è‡´äº¤æ˜“è®°å½•å½’é›¶ï¼Œä½† MetaMask è¿˜è®°ç€æ—§çš„äº¤æ˜“ Nonceï¼ˆè¯•å›¾å‘èµ·è¦†ç›–äº¤æ˜“è¢«æ‹’ç»ï¼‰ã€‚
è§£æ³•ï¼š æ‰“å¼€ MetaMask -> è®¾ç½® -> é«˜çº§ -> ç‚¹å‡» æ¸…é™¤æ´»åŠ¨æ ‡ç­¾é¡µæ•°æ® (Clear activity tab data)ã€‚

#### 2.æŠ¥é”™ï¼šInvalid block tag XX æˆ– Returned no data ("0x")
ç—…å› ï¼š å‰ç«¯ Wagmi ç¼“å­˜äº†æ—§çš„åŒºå—é«˜åº¦ï¼Œæˆ–è€…è¯·æ±‚äº†å·²è¢«é”€æ¯çš„æ—§åˆçº¦åœ°å€ã€‚
è§£æ³•ï¼š 
   1. ç¡®è®¤ .env ä¸­çš„åˆçº¦åœ°å€æ˜¯æœ€æ–°éƒ¨ç½²çš„ï¼Œä¸”å·²é‡å¯å‰ç«¯æœåŠ¡ã€‚
   2. æŒ‰ F12 æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å° -> Application æ ‡ç­¾ -> å·¦ä¾§æ‰¾åˆ° Storage -> ç‚¹å‡» Clear site data (æ¸…é™¤ç½‘ç«™æ•°æ®)ã€‚
   3. Ctrl + F5 å¼ºåˆ¶åˆ·æ–°é¡µé¢ã€‚

#### 3.æŠ¥é”™ï¼šGas limit exceeds gas cap (57000000)
ç—…å› ï¼š Viem åœ¨å‘èµ·äº¤æ˜“å‰æ¨¡æ‹Ÿä¼°ç®— Gas å¤±è´¥ï¼ˆé€šå¸¸å› ä¸ºæ— å‚ payable æ–¹æ³•åœ¨æœ¬åœ°ç¯å¢ƒçš„æ¨¡æ‹Ÿä¸Šä¸‹æ–‡ä¸¢å¤±ï¼Œå¯¼è‡´åˆçº¦ç›´æ¥æ‹¦æˆªï¼‰ã€‚
è§£æ³•ï¼ˆç»ˆæé˜²å‘å¤§æ³•ï¼‰ï¼š æ”¾å¼ƒä½¿ç”¨å¿«æ·å†™å…¥è¯­æ³•ï¼Œç›´æ¥ä½¿ç”¨åº•å±‚ walletClient (data) è°ƒç”¨ï¼Œå¹¶åœ¨ä»£ç ä¸­å¼ºè¡ŒæŒ‡å®š Gasï¼Œè·³è¿‡æ¨¡æ‹Ÿé˜¶æ®µç›´é€šé“¾ä¸Šï¼š

```TypeScript

const tx = await data.writeContract({
address: StakeContractAddress,
abi: stakeAbi,
functionName: 'depositETH', // æˆ– claim, withdraw
value: parseUnits(amount, 18),
gas: 3000000n // ğŸŒŸ å¼ºè¡ŒæŒ‡å®š Gasï¼Œç»•è¿‡ Viem çš„æœ¬åœ°ä¼°ç®— Bugï¼
});
```

#### 4.å¹½çµåˆçº¦ï¼ˆæ”¹äº†é€»è¾‘ä¸ç”Ÿæ•ˆï¼‰
ç—…å› ï¼š é‡‡ç”¨äº† UUPS ä»£ç†æ¨¡å¼ï¼ŒHardhat æ¡†æ¶å¯èƒ½æ­»é”åœ¨æœ¬åœ° .openzeppelin æ–‡ä»¶å¤¹çš„å†å²ç¼“å­˜ä¸­ã€‚
è§£æ³•ï¼š åˆ é™¤é¡¹ç›®åç«¯çš„ .openzeppelin æ–‡ä»¶å¤¹ï¼Œé‡å¯ hardhat nodeï¼Œé‡æ–°è¿è¡Œ deploy.js å³å¯å½»åº•åˆ·æ–°é€»è¾‘åˆçº¦ã€‚
